<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="description" content="Spr√°va osobn√≠ch financ√≠">
  <meta name="theme-color" content="#10b981">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Finance Pro">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
  <title>Moje Finance Pro</title>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    /* Install Prompt Styling */
    #installPrompt {
      position: fixed;
      bottom: 20px;
      left: 20px;
      right: 20px;
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(16, 185, 129, 0.6);
      display: none;
      z-index: 10001;
      animation: slideUp 0.4s ease;
    }
    
    #installPrompt.show {
      display: block;
    }
    
    @keyframes slideUp {
      from {
        transform: translateY(150px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    .install-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 10px;
    }
    
    .install-text {
      font-size: 15px;
      margin-bottom: 20px;
      opacity: 0.95;
      line-height: 1.4;
    }
    
    .install-buttons {
      display: flex;
      gap: 12px;
    }
    
    .install-buttons button {
      flex: 1;
      padding: 14px;
      border: none;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
      font-size: 15px;
      transition: all 0.3s;
    }
    
    #installYes {
      background: white;
      color: #059669;
    }
    
    #installYes:active {
      transform: scale(0.95);
    }
    
    #installNo {
      background: rgba(255, 255, 255, 0.25);
      color: white;
    }
    
    #installNo:active {
      transform: scale(0.95);
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: #f1f5f9;
      min-height: 100vh;
      overflow-x: hidden;
    }
    
    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 0 0 80px 0;
    }
    
    /* Header */
    .header {
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(10px);
      padding: 20px;
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 2px solid #10b981;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .hamburger {
      width: 30px;
      height: 30px;
      display: flex;
      flex-direction: column;
      justify-content: space-around;
      cursor: pointer;
      padding: 5px 0;
    }
    
    .hamburger span {
      width: 100%;
      height: 3px;
      background: #10b981;
      border-radius: 2px;
      transition: all 0.3s;
    }
    
    .header-content {
      flex: 1;
    }
    
    .header h1 {
      font-size: 20px;
      background: linear-gradient(135deg, #10b981, #06b6d4);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 5px;
    }
    
    .total-balance {
      font-size: 28px;
      font-weight: 700;
      color: #10b981;
    }
    
    .balance-label {
      font-size: 12px;
      color: #94a3b8;
      margin-top: 3px;
    }
    
    /* Side Menu */
    .side-menu {
      position: fixed;
      top: 0;
      left: -280px;
      width: 280px;
      height: 100%;
      background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
      z-index: 1001;
      transition: left 0.3s ease;
      overflow-y: auto;
      padding: 20px 0;
    }
    
    .side-menu.open {
      left: 0;
    }
    
    .menu-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      display: none;
    }
    
    .menu-overlay.show {
      display: block;
    }
    
    .menu-header {
      padding: 0 20px 20px;
      border-bottom: 1px solid rgba(16, 185, 129, 0.2);
    }
    
    .menu-title {
      font-size: 22px;
      font-weight: 700;
      color: #10b981;
    }
    
    .menu-item {
      padding: 15px 20px;
      cursor: pointer;
      transition: all 0.3s;
      border-left: 3px solid transparent;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 15px;
    }
    
    .menu-item:hover {
      background: rgba(16, 185, 129, 0.1);
      border-left-color: #10b981;
    }
    
    .menu-item-icon {
      font-size: 20px;
      width: 24px;
      text-align: center;
    }
    
    /* Navigation */
    .nav {
      background: rgba(30, 41, 59, 0.8);
      padding: 15px;
      position: sticky;
      top: 105px;
      z-index: 99;
      display: flex;
      gap: 10px;
      overflow-x: auto;
      border-bottom: 1px solid rgba(16, 185, 129, 0.2);
    }
    
    .nav::-webkit-scrollbar {
      display: none;
    }
    
    .nav-btn {
      padding: 10px 20px;
      border: 1px solid rgba(148, 163, 184, 0.2);
      background: transparent;
      color: #94a3b8;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      white-space: nowrap;
      transition: all 0.3s;
    }
    
    .nav-btn.active {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      border: none;
    }
    
    /* Content */
    .content {
      padding: 20px;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* Cards */
    .card {
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.9), rgba(51, 65, 85, 0.8));
      border: 1px solid rgba(16, 185, 129, 0.2);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 15px;
    }
    
    .card-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 15px;
      color: #f1f5f9;
    }
    
    .account-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .account-card {
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.9), rgba(51, 65, 85, 0.8));
      border: 1px solid rgba(16, 185, 129, 0.2);
      border-radius: 12px;
      padding: 15px;
    }
    
    .account-name {
      font-size: 14px;
      color: #94a3b8;
      margin-bottom: 10px;
    }
    
    .account-balance {
      font-size: 24px;
      font-weight: 700;
      color: #10b981;
    }
    
    /* Stats */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.9), rgba(51, 65, 85, 0.8));
      border: 1px solid rgba(16, 185, 129, 0.2);
      border-radius: 12px;
      padding: 15px;
    }
    
    .stat-label {
      font-size: 12px;
      color: #94a3b8;
      margin-bottom: 8px;
    }
    
    .stat-value {
      font-size: 20px;
      font-weight: 700;
    }
    
    .stat-value.income {
      color: #10b981;
    }
    
    .stat-value.expense {
      color: #ef4444;
    }
    
    /* Transaction list */
    .transaction {
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.9), rgba(51, 65, 85, 0.8));
      border: 1px solid rgba(16, 185, 129, 0.2);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .transaction-badge {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      margin-right: 12px;
    }
    
    .transaction-info {
      flex: 1;
    }
    
    .transaction-category {
      font-weight: 600;
      color: #f1f5f9;
      margin-bottom: 5px;
    }
    
    .transaction-details {
      font-size: 12px;
      color: #94a3b8;
    }
    
    .transaction-amount {
      font-size: 18px;
      font-weight: 700;
    }
    
    .transaction-amount.income {
      color: #10b981;
    }
    
    .transaction-amount.expense {
      color: #ef4444;
    }
    
    /* Progress Bar */
    .progress-container {
      margin-top: 10px;
    }
    
    .progress-label {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: #94a3b8;
      margin-bottom: 8px;
    }
    
    .progress-bar {
      height: 12px;
      background: rgba(148, 163, 184, 0.2);
      border-radius: 6px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #10b981, #06b6d4);
      transition: width 0.5s ease;
      border-radius: 6px;
    }
    
    /* Envelope/Goal Card */
    .envelope-card {
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.9), rgba(51, 65, 85, 0.8));
      border: 1px solid rgba(16, 185, 129, 0.2);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .envelope-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(16, 185, 129, 0.2);
    }
    
    .envelope-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .envelope-name {
      font-size: 18px;
      font-weight: 700;
      color: #f1f5f9;
    }
    
    .envelope-amount {
      font-size: 24px;
      font-weight: 700;
      color: #10b981;
    }
    
    /* Category badge */
    .category-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-right: 8px;
      margin-bottom: 8px;
    }
    
    /* Buttons */
    .btn-primary {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      border: none;
      padding: 15px 25px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      margin-bottom: 10px;
    }
    
    .btn-secondary {
      background: rgba(148, 163, 184, 0.1);
      color: #94a3b8;
      border: 1px solid rgba(148, 163, 184, 0.3);
      padding: 15px 25px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
    }
    
    .btn-small {
      padding: 8px 16px;
      font-size: 14px;
      width: auto;
      display: inline-block;
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
      border: none;
    }
    
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .modal.show {
      display: flex;
    }
    
    .modal-content {
      background: linear-gradient(135deg, #1e293b, #334155);
      border: 2px solid #10b981;
      border-radius: 20px;
      padding: 25px;
      width: 100%;
      max-width: 400px;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal h3 {
      font-size: 20px;
      margin-bottom: 20px;
      color: #f1f5f9;
    }
    
    /* Form */
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-label {
      display: block;
      font-size: 14px;
      color: #94a3b8;
      margin-bottom: 8px;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 12px;
      background: rgba(148, 163, 184, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      border-radius: 8px;
      color: #f1f5f9;
      font-size: 16px;
      font-family: inherit;
    }
    
    textarea {
      resize: vertical;
      min-height: 60px;
    }
    
    .type-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .type-btn {
      flex: 1;
      padding: 12px;
      border: 1px solid rgba(16, 185, 129, 0.3);
      border-radius: 8px;
      background: rgba(148, 163, 184, 0.1);
      color: #94a3b8;
      cursor: pointer;
      font-weight: 600;
    }
    
    .type-btn.active {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      border: none;
    }
    
    .type-btn.active.expense {
      background: linear-gradient(135deg, #ef4444, #dc2626);
    }
    
    .form-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #94a3b8;
    }
    
    /* Color picker */
    .color-picker {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 10px;
      margin-top: 10px;
    }
    
    .color-option {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      border: 3px solid transparent;
      transition: all 0.3s;
    }
    
    .color-option.selected {
      border-color: #10b981;
      transform: scale(1.1);
    }
    
    /* Chart */
    .chart-container {
      position: relative;
      margin: 20px auto;
      max-width: 300px;
    }
    
    canvas {
      max-width: 100%;
      height: auto;
    }
    
    .chart-legend {
      margin-top: 20px;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      padding: 10px;
      margin-bottom: 8px;
      background: rgba(30, 41, 59, 0.5);
      border-radius: 8px;
      cursor: pointer;
    }
    
    .legend-color {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      margin-right: 12px;
    }
    
    .legend-label {
      flex: 1;
      font-size: 14px;
    }
    
    .legend-value {
      font-weight: 700;
      color: #10b981;
    }
    
    /* FAB */
    .fab {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, #10b981, #059669);
      border-radius: 50%;
      border: none;
      box-shadow: 0 4px 20px rgba(16, 185, 129, 0.4);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      color: white;
      z-index: 98;
    }
  </style>
</head>
<body>
  <!-- Side Menu -->
  <div class="menu-overlay" id="menuOverlay" onclick="toggleMenu()"></div>
  <div class="side-menu" id="sideMenu">
    <div class="menu-header">
      <div class="menu-title">Menu</div>
    </div>
    <div class="menu-item" onclick="openCategories()">
      <span class="menu-item-icon">üè∑Ô∏è</span>
      <span>Kategorie</span>
    </div>
    <div class="menu-item" onclick="openRecurring()">
      <span class="menu-item-icon">üîÑ</span>
      <span>Trval√© p≈ô√≠kazy</span>
    </div>
    <div class="menu-item" onclick="openPlanned()">
      <span class="menu-item-icon">üìÖ</span>
      <span>Napl√°novan√© platby</span>
    </div>
    <div class="menu-item" onclick="openEnvelopes()">
      <span class="menu-item-icon">‚úâÔ∏è</span>
      <span>Ob√°lky</span>
    </div>
    <div class="menu-item" onclick="openGoals()">
      <span class="menu-item-icon">üéØ</span>
      <span>Finanƒçn√≠ c√≠le</span>
    </div>
    <div class="menu-item" onclick="openAccounts()">
      <span class="menu-item-icon">üè¶</span>
      <span>Spravovat √∫ƒçty</span>
    </div>
    <div class="menu-item" onclick="document.getElementById('importFile').click()">
      <span class="menu-item-icon">üì•</span>
      <span>Import dat (CSV)</span>
    </div>
    <input type="file" id="importFile" accept=".csv" style="display: none;" onchange="importCSV(event)">
  </div>
  
  <!-- Header -->
  <div class="header">
    <div class="hamburger" onclick="toggleMenu()">
      <span></span>
      <span></span>
      <span></span>
    </div>
    <div class="header-content">
      <h1>Moje Finance Pro</h1>
      <div class="total-balance" id="totalBalance">0 Kƒç</div>
      <div class="balance-label">Celkov√Ω z≈Østatek</div>
    </div>
  </div>
  
  <!-- Navigation -->
  <div class="nav">
    <button class="nav-btn active" onclick="switchTab('dashboard')">P≈ôehled</button>
    <button class="nav-btn" onclick="switchTab('transactions')">Transakce</button>
    <button class="nav-btn" onclick="switchTab('accounts')">√öƒçty</button>
    <button class="nav-btn" onclick="switchTab('charts')">Grafy</button>
  </div>
  
  <div class="container">
    <!-- Dashboard Tab -->
    <div id="dashboard" class="tab-content active content">
      <div class="account-grid" id="accountsGrid">
        <!-- Dynamically generated -->
      </div>
      
      <div class="card">
        <div class="card-title">Tento mƒõs√≠c</div>
        <div class="stats-grid">
          <div class="stat-card" style="cursor: pointer;" onclick="showMonthlyDetail('income')">
            <div class="stat-label">P≈ô√≠jmy</div>
            <div class="stat-value income" id="monthIncome">+0 Kƒç</div>
          </div>
          <div class="stat-card" style="cursor: pointer;" onclick="showMonthlyDetail('expense')">
            <div class="stat-label">V√Ωdaje</div>
            <div class="stat-value expense" id="monthExpense">-0 Kƒç</div>
          </div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-title">Posledn√≠ transakce</div>
        <div id="recentTransactions"></div>
      </div>
    </div>
    
    <!-- Transactions Tab -->
    <div id="transactions" class="tab-content content">
      <div class="card">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
          <button onclick="changeMonth(-1)" style="background: rgba(16, 185, 129, 0.2); border: none; color: #10b981; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-size: 18px; font-weight: 700;">‚Äπ</button>
          <div style="font-size: 18px; font-weight: 700; color: #10b981;" id="currentMonth">√önor 2026</div>
          <button onclick="changeMonth(1)" style="background: rgba(16, 185, 129, 0.2); border: none; color: #10b981; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-size: 18px; font-weight: 700;">‚Ä∫</button>
        </div>
        <div id="allTransactions"></div>
      </div>
    </div>
    
    <!-- Accounts Tab -->
    <div id="accounts" class="tab-content content">
      <div class="card">
        <div class="card-title">Detaily √∫ƒçt≈Ø</div>
        <div id="accountDetails"></div>
      </div>
    </div>
    
    <!-- Charts Tab -->
    <div id="charts" class="tab-content content">
      <div class="card">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
          <button onclick="changeChartMonth(-1)" style="background: rgba(16, 185, 129, 0.2); border: none; color: #10b981; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-size: 18px; font-weight: 700;">‚Äπ</button>
          <div style="font-size: 18px; font-weight: 700; color: #10b981;" id="chartMonth">√önor 2026</div>
          <button onclick="changeChartMonth(1)" style="background: rgba(16, 185, 129, 0.2); border: none; color: #10b981; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-size: 18px; font-weight: 700;">‚Ä∫</button>
        </div>
      </div>
      
      <div class="card">
        <div class="card-title">P≈ô√≠jmy vs V√Ωdaje</div>
        <canvas id="incomeExpenseChart" width="300" height="300"></canvas>
        <div id="incomeExpenseeLegend" class="chart-legend"></div>
      </div>
      
      <div class="card">
        <div class="card-title">V√Ωdaje podle kategori√≠</div>
        <canvas id="categoryChart" width="300" height="300"></canvas>
        <div id="categoryLegend" class="chart-legend"></div>
      </div>
      
      <div class="card">
        <div class="card-title">V√Ωdaje podle √∫ƒçt≈Ø</div>
        <canvas id="accountChart" width="300" height="300"></canvas>
        <div id="accountLegend" class="chart-legend"></div>
      </div>
      
      <div class="card">
        <div class="card-title">P≈ô√≠jmy podle √∫ƒçt≈Ø</div>
        <canvas id="incomeAccountChart" width="300" height="300"></canvas>
        <div id="incomeAccountLegend" class="chart-legend"></div>
      </div>
    </div>
  </div>
  
  <!-- FAB -->
  <button class="fab" onclick="showAddModal()">+</button>
  
  <!-- Add Transaction Modal -->
  <div id="addModal" class="modal">
    <div class="modal-content">
      <h3>Nov√° transakce</h3>
      
      <div class="type-buttons">
        <button class="type-btn" id="incomeBtn" onclick="setType('income')">P≈ô√≠jem</button>
        <button class="type-btn active expense" id="expenseBtn" onclick="setType('expense')">V√Ωdaj</button>
      </div>
      
      <div class="form-group">
        <label class="form-label">ƒå√°stka (Kƒç)</label>
        <input type="number" id="amount" placeholder="0" />
      </div>
      
      <div class="form-group">
        <label class="form-label">Kategorie</label>
        <select id="category"></select>
      </div>
      
      <div class="form-group">
        <label class="form-label">√öƒçet</label>
        <select id="account">
          <option value="cash">Hotovost</option>
          <option value="checking">Bƒõ≈æn√Ω √∫ƒçet</option>
          <option value="savings">Spo≈ôic√≠ √∫ƒçet</option>
          <option value="business">Podnikatelsk√Ω √∫ƒçet</option>
        </select>
      </div>
      
      <div class="form-group">
        <label class="form-label">Popis (voliteln√©)</label>
        <input type="text" id="description" placeholder="Nap≈ô. N√°kup v Albertu" />
      </div>
      
      <div class="form-group">
        <label class="form-label">Datum</label>
        <input type="date" id="date" />
      </div>
      
      <div class="form-actions">
        <button class="btn-secondary" onclick="closeModal('addModal')">Zru≈°it</button>
        <button class="btn-primary" onclick="addTransaction()">P≈ôidat</button>
      </div>
    </div>
  </div>
  
  <!-- Categories Modal -->
  <div id="categoriesModal" class="modal">
    <div class="modal-content">
      <h3>Spr√°va kategori√≠</h3>
      
      <div style="margin-bottom: 20px;">
        <h4 style="color: #10b981; margin-bottom: 10px;">Kategorie v√Ωdaj≈Ø</h4>
        <div id="expenseCategories"></div>
        <button class="btn-primary btn-small" onclick="showAddCategory('expense')" style="margin-top: 10px;">+ P≈ôidat kategorii</button>
      </div>
      
      <div style="margin-bottom: 20px;">
        <h4 style="color: #10b981; margin-bottom: 10px;">Kategorie p≈ô√≠jm≈Ø</h4>
        <div id="incomeCategories"></div>
        <button class="btn-primary btn-small" onclick="showAddCategory('income')" style="margin-top: 10px;">+ P≈ôidat kategorii</button>
      </div>
      
      <button class="btn-secondary" onclick="closeModal('categoriesModal')">Zav≈ô√≠t</button>
    </div>
  </div>
  
  <!-- Add Category Modal -->
  <div id="addCategoryModal" class="modal">
    <div class="modal-content">
      <h3>Nov√° kategorie</h3>
      
      <div class="form-group">
        <label class="form-label">N√°zev</label>
        <input type="text" id="categoryName" placeholder="Nap≈ô. Restaurant" />
      </div>
      
      <div class="form-group">
        <label class="form-label">Barva</label>
        <div class="color-picker" id="colorPicker"></div>
      </div>
      
      <div class="form-actions">
        <button class="btn-secondary" onclick="closeModal('addCategoryModal')">Zru≈°it</button>
        <button class="btn-primary" onclick="saveCategory()">Ulo≈æit</button>
      </div>
    </div>
  </div>
  
  <!-- Recurring Payments Modal -->
  <div id="recurringModal" class="modal">
    <div class="modal-content">
      <h3>Trval√© p≈ô√≠kazy</h3>
      <div id="recurringList"></div>
      <button class="btn-primary" onclick="showAddRecurring()">+ P≈ôidat trval√Ω p≈ô√≠kaz</button>
      <button class="btn-secondary" onclick="closeModal('recurringModal')" style="margin-top: 10px;">Zav≈ô√≠t</button>
    </div>
  </div>
  
  <!-- Add Recurring Modal -->
  <div id="addRecurringModal" class="modal">
    <div class="modal-content">
      <h3>Nov√Ω trval√Ω p≈ô√≠kaz</h3>
      
      <div class="form-group">
        <label class="form-label">N√°zev</label>
        <input type="text" id="recurringName" placeholder="Nap≈ô. Netflix" />
      </div>
      
      <div class="form-group">
        <label class="form-label">ƒå√°stka (Kƒç)</label>
        <input type="number" id="recurringAmount" placeholder="0" />
      </div>
      
      <div class="form-group">
        <label class="form-label">Kategorie</label>
        <select id="recurringCategory"></select>
      </div>
      
      <div class="form-group">
        <label class="form-label">√öƒçet</label>
        <select id="recurringAccount">
          <option value="cash">Hotovost</option>
          <option value="checking">Bƒõ≈æn√Ω √∫ƒçet</option>
          <option value="savings">Spo≈ôic√≠ √∫ƒçet</option>
          <option value="business">Podnikatelsk√Ω √∫ƒçet</option>
        </select>
      </div>
      
      <div class="form-group">
        <label class="form-label">Den v mƒõs√≠ci (1-31)</label>
        <input type="number" id="recurringDay" min="1" max="31" value="1" />
      </div>
      
      <div class="form-actions">
        <button class="btn-secondary" onclick="closeModal('addRecurringModal')">Zru≈°it</button>
        <button class="btn-primary" onclick="saveRecurring()">Ulo≈æit</button>
      </div>
    </div>
  </div>
  
  <!-- Planned Payments Modal -->
  <div id="plannedModal" class="modal">
    <div class="modal-content">
      <h3>Napl√°novan√© platby</h3>
      <div id="plannedList"></div>
      <button class="btn-primary" onclick="showAddPlanned()">+ P≈ôidat platbu</button>
      <button class="btn-secondary" onclick="closeModal('plannedModal')" style="margin-top: 10px;">Zav≈ô√≠t</button>
    </div>
  </div>
  
  <!-- Add Planned Payment Modal -->
  <div id="addPlannedModal" class="modal">
    <div class="modal-content">
      <h3>Nov√° napl√°novan√° platba</h3>
      
      <div class="form-group">
        <label class="form-label">N√°zev</label>
        <input type="text" id="plannedName" placeholder="Nap≈ô. Poji≈°tƒõn√≠ auta" />
      </div>
      
      <div class="form-group">
        <label class="form-label">ƒå√°stka (Kƒç)</label>
        <input type="number" id="plannedAmount" placeholder="0" />
      </div>
      
      <div class="form-group">
        <label class="form-label">Kategorie</label>
        <select id="plannedCategory"></select>
      </div>
      
      <div class="form-group">
        <label class="form-label">√öƒçet</label>
        <select id="plannedAccount">
          <option value="cash">Hotovost</option>
          <option value="checking">Bƒõ≈æn√Ω √∫ƒçet</option>
          <option value="savings">Spo≈ôic√≠ √∫ƒçet</option>
          <option value="business">Podnikatelsk√Ω √∫ƒçet</option>
        </select>
      </div>
      
      <div class="form-group">
        <label class="form-label">Datum splatnosti</label>
        <input type="date" id="plannedDate" />
      </div>
      
      <div class="form-actions">
        <button class="btn-secondary" onclick="closeModal('addPlannedModal')">Zru≈°it</button>
        <button class="btn-primary" onclick="savePlanned()">Ulo≈æit</button>
      </div>
    </div>
  </div>
  
  <!-- Envelopes Modal -->
  <div id="envelopesModal" class="modal">
    <div class="modal-content">
      <h3>Spo≈ôic√≠ ob√°lky</h3>
      <div id="envelopesList"></div>
      <button class="btn-primary" onclick="showAddEnvelope()">+ P≈ôidat ob√°lku</button>
      <button class="btn-secondary" onclick="closeModal('envelopesModal')" style="margin-top: 10px;">Zav≈ô√≠t</button>
    </div>
  </div>
  
  <!-- Add Envelope Modal -->
  <div id="addEnvelopeModal" class="modal">
    <div class="modal-content">
      <h3>Nov√° spo≈ôic√≠ ob√°lka</h3>
      
      <div class="form-group">
        <label class="form-label">N√°zev</label>
        <input type="text" id="envelopeName" placeholder="Nap≈ô. Dovolen√°" />
      </div>
      
      <div class="form-group">
        <label class="form-label">C√≠lov√° ƒç√°stka (Kƒç)</label>
        <input type="number" id="envelopeTarget" placeholder="0" />
      </div>
      
      <div class="form-group">
        <label class="form-label">Ji≈æ naspo≈ôeno (Kƒç)</label>
        <input type="number" id="envelopeCurrent" placeholder="0" value="0" />
      </div>
      
      <div class="form-actions">
        <button class="btn-secondary" onclick="closeModal('addEnvelopeModal')">Zru≈°it</button>
        <button class="btn-primary" onclick="saveEnvelope()">Ulo≈æit</button>
      </div>
    </div>
  </div>
  
  <!-- Goals Modal -->
  <div id="goalsModal" class="modal">
    <div class="modal-content">
      <h3>Finanƒçn√≠ c√≠le</h3>
      <div id="goalsList"></div>
      <button class="btn-primary" onclick="showAddGoal()">+ P≈ôidat c√≠l</button>
      <button class="btn-secondary" onclick="closeModal('goalsModal')" style="margin-top: 10px;">Zav≈ô√≠t</button>
    </div>
  </div>
  
  <!-- Add Goal Modal -->
  <div id="addGoalModal" class="modal">
    <div class="modal-content">
      <h3>Nov√Ω finanƒçn√≠ c√≠l</h3>
      
      <div class="form-group">
        <label class="form-label">N√°zev</label>
        <input type="text" id="goalName" placeholder="Nap≈ô. Nov√© auto" />
      </div>
      
      <div class="form-group">
        <label class="form-label">C√≠lov√° ƒç√°stka (Kƒç)</label>
        <input type="number" id="goalTarget" placeholder="0" />
      </div>
      
      <div class="form-group">
        <label class="form-label">Ji≈æ naspo≈ôeno (Kƒç)</label>
        <input type="number" id="goalCurrent" placeholder="0" value="0" />
      </div>
      
      <div class="form-group">
        <label class="form-label">Datum c√≠le</label>
        <input type="date" id="goalDate" />
      </div>
      
      <div class="form-actions">
        <button class="btn-secondary" onclick="closeModal('addGoalModal')">Zru≈°it</button>
        <button class="btn-primary" onclick="saveGoal()">Ulo≈æit</button>
      </div>
    </div>
  </div>
  
  <!-- Edit Transaction Modal -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <h3>Upravit transakci</h3>
      
      <div class="form-group">
        <label class="form-label">ƒå√°stka (Kƒç)</label>
        <input type="number" id="editAmount" />
      </div>
      
      <div class="form-group">
        <label class="form-label">Kategorie</label>
        <select id="editCategory"></select>
      </div>
      
      <div class="form-group">
        <label class="form-label">√öƒçet</label>
        <select id="editAccount">
          <option value="cash">Hotovost</option>
          <option value="checking">Bƒõ≈æn√Ω √∫ƒçet</option>
          <option value="savings">Spo≈ôic√≠ √∫ƒçet</option>
          <option value="business">Podnikatelsk√Ω √∫ƒçet</option>
        </select>
      </div>
      
      <div class="form-group">
        <label class="form-label">Popis</label>
        <input type="text" id="editDescription" />
      </div>
      
      <div class="form-group">
        <label class="form-label">Datum</label>
        <input type="date" id="editDate" />
      </div>
      
      <div class="form-group">
        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; color: #10b981; font-weight: 600;">
          <input type="checkbox" id="applyToAll" style="width: 20px; height: 20px; cursor: pointer;">
          <span>Pou≈æ√≠t na v≈°echny stejn√© platby (podle popisu)</span>
        </label>
        <div style="font-size: 12px; color: #94a3b8; margin-top: 5px; margin-left: 30px;">
          Zmƒõn√≠ kategorii a √∫ƒçet u v≈°ech transakc√≠ se stejn√Ωm popisem
        </div>
      </div>
      
      <div class="form-actions">
        <button class="btn-danger" onclick="deleteTransaction()">Smazat</button>
        <button class="btn-secondary" onclick="closeModal('editModal')">Zru≈°it</button>
        <button class="btn-primary" onclick="saveEditTransaction()">Ulo≈æit</button>
      </div>
    </div>
  </div>
  
  <!-- Accounts Management Modal -->
  <div id="accountsModal" class="modal">
    <div class="modal-content">
      <h3>Spravovat √∫ƒçty</h3>
      
      <div id="accountsList"></div>
      
      <button class="btn-primary" onclick="showAddAccountModal()" style="margin-top: 20px;">+ P≈ôidat nov√Ω √∫ƒçet</button>
      <button class="btn-secondary" onclick="closeModal('accountsModal')" style="margin-top: 10px;">Zav≈ô√≠t</button>
    </div>
  </div>
  
  <!-- Add Account Modal -->
  <div id="addAccountModal" class="modal">
    <div class="modal-content">
      <h3>P≈ôidat nov√Ω √∫ƒçet</h3>
      
      <div class="form-group">
        <label class="form-label">N√°zev √∫ƒçtu</label>
        <input type="text" id="newAccountName" placeholder="nap≈ô. Kreditn√≠ karta" />
      </div>
      
      <div class="form-group">
        <label class="form-label">Ikona (emoji)</label>
        <input type="text" id="newAccountIcon" placeholder="nap≈ô. üí≥" maxlength="2" />
      </div>
      
      <div class="form-group">
        <label class="form-label">Poƒç√°teƒçn√≠ stav (Kƒç)</label>
        <input type="number" id="newAccountBalance" value="0" step="0.01" />
      </div>
      
      <div class="form-actions">
        <button class="btn-secondary" onclick="closeModal('addAccountModal')">Zru≈°it</button>
        <button class="btn-primary" onclick="addNewAccount()">P≈ôidat √∫ƒçet</button>
      </div>
    </div>
  </div>
  
  <!-- Edit Account Modal -->
  <div id="editAccountModal" class="modal">
    <div class="modal-content">
      <h3>Upravit √∫ƒçet</h3>
      
      <div class="form-group">
        <label class="form-label">N√°zev √∫ƒçtu</label>
        <input type="text" id="editAccountName" />
      </div>
      
      <div class="form-group">
        <label class="form-label">Ikona (emoji)</label>
        <input type="text" id="editAccountIcon" maxlength="2" />
      </div>
      
      <div class="form-group">
        <label class="form-label">Poƒç√°teƒçn√≠ stav (Kƒç)</label>
        <input type="number" id="editAccountBalance" step="0.01" />
        <div style="font-size: 12px; color: #94a3b8; margin-top: 5px;">
          Uprav√≠ se pouze poƒç√°teƒçn√≠ stav, transakce z≈Østanou
        </div>
      </div>
      
      <div class="form-actions">
        <button class="btn-danger" onclick="deleteAccount()">Smazat √∫ƒçet</button>
        <button class="btn-secondary" onclick="closeModal('editAccountModal')">Zru≈°it</button>
        <button class="btn-primary" onclick="saveEditAccount()">Ulo≈æit</button>
      </div>
    </div>
  </div>
  
  <!-- Drill-down Modal -->
  <div id="drilldownModal" class="modal">
    <div class="modal-content">
      <h3 id="drilldownTitle">Detaily</h3>
      <div id="drilldownContent"></div>
      <button class="btn-secondary" onclick="closeModal('drilldownModal')">Zav≈ô√≠t</button>
    </div>
  </div>
  
  <script>
    // Data structure
    let data = {
      transactions: [],
      categories: {
        expense: [
          { name: 'J√≠dlo', color: '#ef4444' },
          { name: 'Bydlen√≠', color: '#f59e0b' },
          { name: 'Doprava', color: '#3b82f6' },
          { name: 'Z√°bava', color: '#8b5cf6' },
          { name: 'Zdrav√≠', color: '#10b981' },
          { name: 'Obleƒçen√≠', color: '#ec4899' },
          { name: 'Ostatn√≠', color: '#6b7280' }
        ],
        income: [
          { name: 'Mzda', color: '#10b981' },
          { name: 'Podnik√°n√≠', color: '#06b6d4' },
          { name: 'Investice', color: '#8b5cf6' },
          { name: 'Dary', color: '#f59e0b' },
          { name: 'Ostatn√≠', color: '#6b7280' }
        ]
      },
      accounts: [
        { id: 'cash', name: 'Hotovost', icon: 'üíµ', initialBalance: 0 },
        { id: 'checking', name: 'Bƒõ≈æn√Ω √∫ƒçet', icon: 'üí≥', initialBalance: 0 },
        { id: 'savings', name: 'Spo≈ôic√≠ √∫ƒçet', icon: 'üè¶', initialBalance: 0 },
        { id: 'business', name: 'Podnikatelsk√Ω √∫ƒçet', icon: 'üíº', initialBalance: 0 }
      ],
      recurring: [],
      planned: [],
      envelopes: [],
      goals: []
    };
    
    let currentType = 'expense';
    let currentCategoryType = 'expense';
    let selectedColor = '#ef4444';
    
    // Month navigation for transactions
    let viewMonth = new Date().getMonth();
    let viewYear = new Date().getFullYear();
    
    // Month navigation for charts
    let chartMonth = new Date().getMonth();
    let chartYear = new Date().getFullYear();
    
    const monthNames = ['Leden', '√önor', 'B≈ôezen', 'Duben', 'Kvƒõten', 'ƒåerven', 'ƒåervenec', 'Srpen', 'Z√°≈ô√≠', '≈ò√≠jen', 'Listopad', 'Prosinec'];
    
    function changeMonth(direction) {
      viewMonth += direction;
      if (viewMonth > 11) {
        viewMonth = 0;
        viewYear++;
      } else if (viewMonth < 0) {
        viewMonth = 11;
        viewYear--;
      }
      updateUI();
    }
    
    function changeChartMonth(direction) {
      chartMonth += direction;
      if (chartMonth > 11) {
        chartMonth = 0;
        chartYear++;
      } else if (chartMonth < 0) {
        chartMonth = 11;
        chartYear--;
      }
      updateCharts();
    }
    
    const colors = ['#ef4444', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6', '#ec4899', '#06b6d4', '#f97316', '#14b8a6', '#6366f1'];
    
    // Load data
    function loadData() {
      const saved = localStorage.getItem('financeDataV2');
      if (saved) {
        data = JSON.parse(saved);
        
        // Migration: Add accounts array if missing
        if (!data.accounts) {
          data.accounts = [
            { id: 'cash', name: 'Hotovost', icon: 'üíµ', initialBalance: 0 },
            { id: 'checking', name: 'Bƒõ≈æn√Ω √∫ƒçet', icon: 'üí≥', initialBalance: 0 },
            { id: 'savings', name: 'Spo≈ôic√≠ √∫ƒçet', icon: 'üè¶', initialBalance: 0 },
            { id: 'business', name: 'Podnikatelsk√Ω √∫ƒçet', icon: 'üíº', initialBalance: 0 }
          ];
          saveData(); // Save migrated data
        }
      }
      processRecurring();
      updateUI();
    }
    
    // Save data
    function saveData() {
      localStorage.setItem('financeDataV2', JSON.stringify(data));
    }
    
    // Process recurring payments
    function processRecurring() {
      const today = new Date();
      const currentDay = today.getDate();
      const currentMonth = today.getMonth();
      const currentYear = today.getFullYear();
      
      data.recurring.forEach(rec => {
        if (!rec.lastProcessed) rec.lastProcessed = null;
        
        const lastDate = rec.lastProcessed ? new Date(rec.lastProcessed) : null;
        const shouldProcess = !lastDate || 
          (lastDate.getMonth() !== currentMonth || lastDate.getFullYear() !== currentYear) &&
          currentDay >= rec.day;
        
        if (shouldProcess) {
          data.transactions.unshift({
            id: Date.now() + Math.random(),
            type: 'expense',
            amount: rec.amount,
            category: rec.category,
            account: rec.account,
            description: `Trval√Ω p≈ô√≠kaz: ${rec.name}`,
            date: new Date().toISOString().split('T')[0]
          });
          rec.lastProcessed = new Date().toISOString();
        }
      });
      
      saveData();
    }
    
    // Format currency
    function formatCurrency(amount) {
      return amount.toLocaleString('cs-CZ') + ' Kƒç';
    }
    
    // Calculate balance
    function calculateBalance(account) {
      const acc = data.accounts.find(a => a.id === account);
      const initialBalance = acc ? acc.initialBalance : 0;
      
      const transactionsBalance = data.transactions
        .filter(t => t.account === account)
        .reduce((sum, t) => sum + (t.type === 'income' ? t.amount : -t.amount), 0);
      
      return initialBalance + transactionsBalance;
    }
    
    // Get total balance
    function getTotalBalance() {
      return data.accounts.reduce((sum, acc) => sum + calculateBalance(acc.id), 0);
    }
    
    // Get monthly stats
    function getMonthlyStats() {
      const now = new Date();
      const month = now.getMonth();
      const year = now.getFullYear();
      
      const monthTx = data.transactions.filter(t => {
        const date = new Date(t.date);
        return date.getMonth() === month && date.getFullYear() === year;
      });
      
      const income = monthTx.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
      const expense = monthTx.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
      
      return { income, expense };
    }
    
    // Get category color
    function getCategoryColor(category, type) {
      const cat = data.categories[type].find(c => c.name === category);
      return cat ? cat.color : '#6b7280';
    }
    
    // Update UI
    function updateUI() {
      // Total balance
      document.getElementById('totalBalance').textContent = formatCurrency(getTotalBalance());
      
      // Account balances - dynamically generate cards
      const accountsHtml = data.accounts.map(acc => `
        <div class="account-card" style="cursor: pointer;" onclick="showAccountDetail('${acc.id}')">
          <div class="account-name">${acc.icon} ${acc.name}</div>
          <div class="account-balance">${formatCurrency(calculateBalance(acc.id))}</div>
        </div>
      `).join('');
      document.getElementById('accountsGrid').innerHTML = accountsHtml;
      
      // Monthly stats
      const stats = getMonthlyStats();
      document.getElementById('monthIncome').textContent = '+' + formatCurrency(stats.income);
      document.getElementById('monthExpense').textContent = '-' + formatCurrency(stats.expense);
      
      // Recent transactions
      const recent = data.transactions.slice(0, 5);
      const recentHtml = recent.length ? recent.map(t => {
        const color = getCategoryColor(t.category, t.type);
        return `
          <div style="display: flex; align-items: center; margin-bottom: 10px; cursor: pointer;" onclick="editTransaction(${t.id})">
            <div class="transaction-badge" style="background: ${color};">
              ${t.type === 'income' ? '‚Üë' : '‚Üì'}
            </div>
            <div style="flex: 1;">
              <div class="transaction-category">${t.category}</div>
              <div class="transaction-details">
                ${t.description || getAccountName(t.account)} ‚Ä¢ ${new Date(t.date).toLocaleDateString('cs-CZ')}
              </div>
            </div>
            <div class="transaction-amount ${t.type}">
              ${t.type === 'income' ? '+' : '-'}${formatCurrency(t.amount)}
            </div>
          </div>
        `;
      }).join('') : '<div class="empty-state">Zat√≠m ≈æ√°dn√© transakce</div>';
      
      document.getElementById('recentTransactions').innerHTML = recentHtml;
      
      // Update month display
      document.getElementById('currentMonth').textContent = `${monthNames[viewMonth]} ${viewYear}`;
      
      // All transactions (filtered by selected month)
      const monthTransactions = data.transactions.filter(t => {
        const date = new Date(t.date);
        return date.getMonth() === viewMonth && date.getFullYear() === viewYear;
      });
      
      const allHtml = monthTransactions.length ? monthTransactions.map(t => {
        const color = getCategoryColor(t.category, t.type);
        return `
          <div style="display: flex; align-items: center; margin-bottom: 10px; cursor: pointer;" onclick="editTransaction(${t.id})">
            <div class="transaction-badge" style="background: ${color};">
              ${t.type === 'income' ? '‚Üë' : '‚Üì'}
            </div>
            <div style="flex: 1;">
              <div class="transaction-category">${t.category}</div>
              <div class="transaction-details">
                ${t.description || getAccountName(t.account)} ‚Ä¢ ${new Date(t.date).toLocaleDateString('cs-CZ')}
              </div>
            </div>
            <div class="transaction-amount ${t.type}">
              ${t.type === 'income' ? '+' : '-'}${formatCurrency(t.amount)}
            </div>
          </div>
        `;
      }).join('') : '<div class="empty-state">≈Ω√°dn√© transakce v tomto mƒõs√≠ci<br><br>Klikni na + pro p≈ôid√°n√≠</div>';
      
      document.getElementById('allTransactions').innerHTML = allHtml;
      
      // Account details
      const accountsHtml = ['cash', 'checking', 'savings', 'business'].map(acc => {
        const balance = calculateBalance(acc);
        const txCount = data.transactions.filter(t => t.account === acc).length;
        return `
          <div style="padding: 15px 0; border-bottom: 1px solid rgba(148, 163, 184, 0.2);">
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
              <span style="font-weight: 600;">${getAccountName(acc)}</span>
              <span style="font-weight: 700; color: #10b981;">${formatCurrency(balance)}</span>
            </div>
            <div style="font-size: 12px; color: #94a3b8;">
              ${txCount} transakc√≠
            </div>
          </div>
        `;
      }).join('');
      
      document.getElementById('accountDetails').innerHTML = accountsHtml;
      
      // Update charts if on charts tab
      if (document.getElementById('charts').classList.contains('active')) {
        updateCharts();
      }
    }
    
    function getAccountName(acc) {
      const account = data.accounts.find(a => a.id === acc);
      return account ? account.name : acc;
    }
    
    function getAccountIcon(acc) {
      const account = data.accounts.find(a => a.id === acc);
      return account ? account.icon : 'üí∞';
    }
    
    // Menu functions
    function toggleMenu() {
      document.getElementById('sideMenu').classList.toggle('open');
      document.getElementById('menuOverlay').classList.toggle('show');
    }
    
    function closeMenu() {
      document.getElementById('sideMenu').classList.remove('open');
      document.getElementById('menuOverlay').classList.remove('show');
    }
    
    // Tab switching
    function switchTab(tab) {
      document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.getElementById(tab).classList.add('active');
      
      if (tab === 'charts') {
        setTimeout(updateCharts, 100);
      }
    }
    
    // Modal functions
    function showModal(id) {
      document.getElementById(id).classList.add('show');
    }
    
    function closeModal(id) {
      document.getElementById(id).classList.remove('show');
    }
    
    // Transaction functions
    function showAddModal() {
      showModal('addModal');
      document.getElementById('date').value = new Date().toISOString().split('T')[0];
      updateCategorySelect();
      updateAccountSelect('account');
    }
    
    function updateAccountSelect(selectId) {
      const select = document.getElementById(selectId);
      if (!select) return;
      
      select.innerHTML = data.accounts.map(acc => 
        `<option value="${acc.id}">${acc.icon} ${acc.name}</option>`
      ).join('');
    }
    
    let currentEditId = null;
    
    function editTransaction(id) {
      currentEditId = id;
      const transaction = data.transactions.find(t => t.id === id);
      if (!transaction) return;
      
      document.getElementById('editAmount').value = transaction.amount;
      document.getElementById('editDescription').value = transaction.description || '';
      document.getElementById('editDate').value = transaction.date;
      
      // Populate categories for the type
      const select = document.getElementById('editCategory');
      select.innerHTML = '';
      data.categories[transaction.type].forEach(cat => {
        const option = document.createElement('option');
        option.value = cat.name;
        option.textContent = cat.name;
        if (cat.name === transaction.category) option.selected = true;
        select.appendChild(option);
      });
      
      // Populate accounts
      updateAccountSelect('editAccount');
      document.getElementById('editAccount').value = transaction.account;
      
      showModal('editModal');
    }
    
    function saveEditTransaction() {
      if (!currentEditId) return;
      
      const transaction = data.transactions.find(t => t.id === currentEditId);
      if (!transaction) return;
      
      const newAmount = parseFloat(document.getElementById('editAmount').value);
      const newCategory = document.getElementById('editCategory').value;
      const newAccount = document.getElementById('editAccount').value;
      const newDescription = document.getElementById('editDescription').value;
      const newDate = document.getElementById('editDate').value;
      const applyToAll = document.getElementById('applyToAll').checked;
      
      if (applyToAll && transaction.description) {
        // Hromadn√° zmƒõna - najdi v≈°echny transakce se stejn√Ωm popisem
        const originalDescription = transaction.description;
        let updatedCount = 0;
        
        data.transactions.forEach(t => {
          if (t.description === originalDescription) {
            t.category = newCategory;
            t.account = newAccount;
            updatedCount++;
          }
        });
        
        // Aktu√°ln√≠ transakci zmƒõ≈à i ƒç√°stku a datum
        transaction.amount = newAmount;
        transaction.description = newDescription;
        transaction.date = newDate;
        
        alert(`‚úÖ Zmƒõnƒõno ${updatedCount} transakc√≠ se stejn√Ωm popisem!`);
      } else {
        // Zmƒõ≈à jen aktu√°ln√≠ transakci
        transaction.amount = newAmount;
        transaction.category = newCategory;
        transaction.account = newAccount;
        transaction.description = newDescription;
        transaction.date = newDate;
      }
      
      saveData();
      updateUI();
      closeModal('editModal');
      currentEditId = null;
    }
    
    function deleteTransaction() {
      if (!currentEditId) return;
      
      if (!confirm('Opravdu smazat tuto transakci?')) return;
      
      data.transactions = data.transactions.filter(t => t.id !== currentEditId);
      saveData();
      updateUI();
      closeModal('editModal');
      currentEditId = null;
    }
    
    function setType(type) {
      currentType = type;
      
      document.getElementById('incomeBtn').classList.remove('active');
      document.getElementById('expenseBtn').classList.remove('active');
      
      if (type === 'income') {
        document.getElementById('incomeBtn').classList.add('active');
      } else {
        document.getElementById('expenseBtn').classList.add('active');
      }
      
      updateCategorySelect();
    }
    
    function updateCategorySelect() {
      const select = document.getElementById('category');
      select.innerHTML = '<option value="">Vyberte kategorii</option>';
      data.categories[currentType].forEach(cat => {
        const option = document.createElement('option');
        option.value = cat.name;
        option.textContent = cat.name;
        select.appendChild(option);
      });
    }
    
    function addTransaction() {
      const amount = parseFloat(document.getElementById('amount').value);
      const category = document.getElementById('category').value;
      const account = document.getElementById('account').value;
      const description = document.getElementById('description').value;
      const date = document.getElementById('date').value;
      
      if (!amount || !category) {
        alert('Vypl≈àte ƒç√°stku a kategorii');
        return;
      }
      
      data.transactions.unshift({
        id: Date.now(),
        type: currentType,
        amount,
        category,
        account,
        description,
        date
      });
      
      saveData();
      updateUI();
      closeModal('addModal');
      
      // Reset form
      document.getElementById('amount').value = '';
      document.getElementById('category').value = '';
      document.getElementById('description').value = '';
    }
    
    // Categories
    function openCategories() {
      closeMenu();
      renderCategories();
      showModal('categoriesModal');
    }
    
    function renderCategories() {
      // Expense categories
      const expHtml = data.categories.expense.map(cat => `
        <div class="category-badge" style="background: ${cat.color}; color: white;">
          ${cat.name}
          <button onclick="deleteCategory('expense', '${cat.name}')" style="background: none; border: none; color: white; margin-left: 8px; cursor: pointer;">√ó</button>
        </div>
      `).join('');
      document.getElementById('expenseCategories').innerHTML = expHtml;
      
      // Income categories
      const incHtml = data.categories.income.map(cat => `
        <div class="category-badge" style="background: ${cat.color}; color: white;">
          ${cat.name}
          <button onclick="deleteCategory('income', '${cat.name}')" style="background: none; border: none; color: white; margin-left: 8px; cursor: pointer;">√ó</button>
        </div>
      `).join('');
      document.getElementById('incomeCategories').innerHTML = incHtml;
    }
    
    function showAddCategory(type) {
      currentCategoryType = type;
      selectedColor = colors[0];
      
      // Render color picker
      const pickerHtml = colors.map(color => `
        <div class="color-option ${color === selectedColor ? 'selected' : ''}" 
             style="background: ${color};"
             onclick="selectColor('${color}')"></div>
      `).join('');
      document.getElementById('colorPicker').innerHTML = pickerHtml;
      
      showModal('addCategoryModal');
    }
    
    function selectColor(color) {
      selectedColor = color;
      document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
      event.target.classList.add('selected');
    }
    
    function saveCategory() {
      const name = document.getElementById('categoryName').value.trim();
      if (!name) {
        alert('Zadejte n√°zev kategorie');
        return;
      }
      
      data.categories[currentCategoryType].push({ name, color: selectedColor });
      saveData();
      closeModal('addCategoryModal');
      renderCategories();
      document.getElementById('categoryName').value = '';
    }
    
    function deleteCategory(type, name) {
      if (!confirm(`Opravdu smazat kategorii "${name}"?`)) return;
      
      data.categories[type] = data.categories[type].filter(c => c.name !== name);
      saveData();
      renderCategories();
      updateUI();
    }
    
    // Recurring payments
    function openRecurring() {
      closeMenu();
      renderRecurring();
      showModal('recurringModal');
    }
    
    function renderRecurring() {
      const html = data.recurring.length ? data.recurring.map(rec => `
        <div class="envelope-card">
          <div class="envelope-header">
            <div class="envelope-name">${rec.name}</div>
            <button class="btn-danger btn-small" onclick="deleteRecurring(${rec.id})">Smazat</button>
          </div>
          <div style="font-size: 14px; color: #94a3b8;">
            ${formatCurrency(rec.amount)} ‚Ä¢ ${rec.category} ‚Ä¢ ${getAccountName(rec.account)} ‚Ä¢ ${rec.day}. v mƒõs√≠ci
          </div>
        </div>
      `).join('') : '<div class="empty-state">Zat√≠m ≈æ√°dn√© trval√© p≈ô√≠kazy</div>';
      
      document.getElementById('recurringList').innerHTML = html;
    }
    
    function showAddRecurring() {
      const select = document.getElementById('recurringCategory');
      select.innerHTML = '<option value="">Vyberte kategorii</option>';
      data.categories.expense.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat.name;
        option.textContent = cat.name;
        select.appendChild(option);
      });
      
      showModal('addRecurringModal');
    }
    
    function saveRecurring() {
      const name = document.getElementById('recurringName').value.trim();
      const amount = parseFloat(document.getElementById('recurringAmount').value);
      const category = document.getElementById('recurringCategory').value;
      const account = document.getElementById('recurringAccount').value;
      const day = parseInt(document.getElementById('recurringDay').value);
      
      if (!name || !amount || !category) {
        alert('Vypl≈àte v≈°echna pole');
        return;
      }
      
      data.recurring.push({
        id: Date.now(),
        name,
        amount,
        category,
        account,
        day,
        lastProcessed: null
      });
      
      saveData();
      closeModal('addRecurringModal');
      renderRecurring();
      
      // Reset form
      document.getElementById('recurringName').value = '';
      document.getElementById('recurringAmount').value = '';
      document.getElementById('recurringDay').value = '1';
    }
    
    function deleteRecurring(id) {
      if (!confirm('Opravdu smazat tento trval√Ω p≈ô√≠kaz?')) return;
      
      data.recurring = data.recurring.filter(r => r.id !== id);
      saveData();
      renderRecurring();
    }
    
    // Planned payments
    function openPlanned() {
      closeMenu();
      renderPlanned();
      showModal('plannedModal');
    }
    
    function renderPlanned() {
      const today = new Date();
      const sorted = [...data.planned].sort((a, b) => new Date(a.date) - new Date(b.date));
      
      const html = sorted.length ? sorted.map(p => {
        const dueDate = new Date(p.date);
        const daysUntil = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
        const isOverdue = daysUntil < 0;
        const isDueSoon = daysUntil >= 0 && daysUntil <= 7;
        
        const statusColor = isOverdue ? '#ef4444' : isDueSoon ? '#f59e0b' : '#10b981';
        const statusText = isOverdue ? 'PO SPLATNOSTI' : isDueSoon ? `Za ${daysUntil} dn≈Ø` : dueDate.toLocaleDateString('cs-CZ');
        
        return `
          <div class="envelope-card">
            <div class="envelope-header">
              <div class="envelope-name">${p.name}</div>
              <div style="display: flex; gap: 8px;">
                <button class="btn-primary btn-small" onclick="realizePlanned(${p.id})">Realizovat</button>
                <button class="btn-danger btn-small" onclick="deletePlanned(${p.id})">Smazat</button>
              </div>
            </div>
            <div style="font-size: 18px; font-weight: 700; color: #ef4444; margin: 10px 0;">
              -${formatCurrency(p.amount)}
            </div>
            <div style="font-size: 14px; color: #94a3b8;">
              ${p.category} ‚Ä¢ ${getAccountName(p.account)}
            </div>
            <div style="font-size: 14px; color: ${statusColor}; margin-top: 8px; font-weight: 600;">
              üìÖ ${statusText}
            </div>
          </div>
        `;
      }).join('') : '<div class="empty-state">Zat√≠m ≈æ√°dn√© napl√°novan√© platby</div>';
      
      document.getElementById('plannedList').innerHTML = html;
    }
    
    function showAddPlanned() {
      const select = document.getElementById('plannedCategory');
      select.innerHTML = '<option value="">Vyberte kategorii</option>';
      data.categories.expense.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat.name;
        option.textContent = cat.name;
        select.appendChild(option);
      });
      
      showModal('addPlannedModal');
    }
    
    function savePlanned() {
      const name = document.getElementById('plannedName').value.trim();
      const amount = parseFloat(document.getElementById('plannedAmount').value);
      const category = document.getElementById('plannedCategory').value;
      const account = document.getElementById('plannedAccount').value;
      const date = document.getElementById('plannedDate').value;
      
      if (!name || !amount || !category || !date) {
        alert('Vypl≈àte v≈°echna pole');
        return;
      }
      
      data.planned.push({
        id: Date.now(),
        name,
        amount,
        category,
        account,
        date
      });
      
      saveData();
      closeModal('addPlannedModal');
      renderPlanned();
      
      // Reset form
      document.getElementById('plannedName').value = '';
      document.getElementById('plannedAmount').value = '';
      document.getElementById('plannedDate').value = '';
    }
    
    function realizePlanned(id) {
      const planned = data.planned.find(p => p.id === id);
      if (!planned) return;
      
      data.transactions.unshift({
        id: Date.now(),
        type: 'expense',
        amount: planned.amount,
        category: planned.category,
        account: planned.account,
        description: `Napl√°novan√° platba: ${planned.name}`,
        date: new Date().toISOString().split('T')[0]
      });
      
      data.planned = data.planned.filter(p => p.id !== id);
      saveData();
      renderPlanned();
      updateUI();
    }
    
    function deletePlanned(id) {
      if (!confirm('Opravdu smazat tuto platbu?')) return;
      
      data.planned = data.planned.filter(p => p.id !== id);
      saveData();
      renderPlanned();
    }
    
    // Envelopes
    function openEnvelopes() {
      closeMenu();
      renderEnvelopes();
      showModal('envelopesModal');
    }
    
    function renderEnvelopes() {
      const html = data.envelopes.length ? data.envelopes.map(env => {
        const progress = (env.current / env.target) * 100;
        return `
          <div class="envelope-card">
            <div class="envelope-header">
              <div class="envelope-name">‚úâÔ∏è ${env.name}</div>
              <button class="btn-danger btn-small" onclick="deleteEnvelope(${env.id})">Smazat</button>
            </div>
            <div class="envelope-amount">${formatCurrency(env.current)}</div>
            <div class="progress-container">
              <div class="progress-label">
                <span>C√≠l: ${formatCurrency(env.target)}</span>
                <span>${progress.toFixed(0)}%</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${Math.min(progress, 100)}%"></div>
              </div>
            </div>
            <button class="btn-primary btn-small" onclick="addToEnvelope(${env.id})" style="margin-top: 15px;">P≈ôidat pen√≠ze</button>
          </div>
        `;
      }).join('') : '<div class="empty-state">Zat√≠m ≈æ√°dn√© ob√°lky</div>';
      
      document.getElementById('envelopesList').innerHTML = html;
    }
    
    function showAddEnvelope() {
      showModal('addEnvelopeModal');
    }
    
    function saveEnvelope() {
      const name = document.getElementById('envelopeName').value.trim();
      const target = parseFloat(document.getElementById('envelopeTarget').value);
      const current = parseFloat(document.getElementById('envelopeCurrent').value) || 0;
      
      if (!name || !target) {
        alert('Vypl≈àte n√°zev a c√≠lovou ƒç√°stku');
        return;
      }
      
      data.envelopes.push({
        id: Date.now(),
        name,
        target,
        current
      });
      
      saveData();
      closeModal('addEnvelopeModal');
      renderEnvelopes();
      
      // Reset form
      document.getElementById('envelopeName').value = '';
      document.getElementById('envelopeTarget').value = '';
      document.getElementById('envelopeCurrent').value = '0';
    }
    
    function addToEnvelope(id) {
      const amount = prompt('Kolik chcete p≈ôidat?');
      if (!amount) return;
      
      const envelope = data.envelopes.find(e => e.id === id);
      if (envelope) {
        envelope.current += parseFloat(amount);
        saveData();
        renderEnvelopes();
      }
    }
    
    function deleteEnvelope(id) {
      if (!confirm('Opravdu smazat tuto ob√°lku?')) return;
      
      data.envelopes = data.envelopes.filter(e => e.id !== id);
      saveData();
      renderEnvelopes();
    }
    
    // Goals
    function openGoals() {
      closeMenu();
      renderGoals();
      showModal('goalsModal');
    }
    
    // Account Management
    function openAccounts() {
      closeMenu();
      renderAccountsList();
      showModal('accountsModal');
    }
    
    function renderAccountsList() {
      const html = data.accounts.map(acc => {
        const balance = calculateBalance(acc.id);
        const transactionCount = data.transactions.filter(t => t.account === acc.id).length;
        
        return `
          <div class="envelope-card" onclick="editAccountModal('${acc.id}')">
            <div class="envelope-header">
              <div class="envelope-name">${acc.icon} ${acc.name}</div>
              <div class="envelope-amount">${formatCurrency(balance)}</div>
            </div>
            <div style="font-size: 13px; color: #94a3b8; margin-top: 10px;">
              Poƒç√°teƒçn√≠ stav: ${formatCurrency(acc.initialBalance)} ‚Ä¢ ${transactionCount} transakc√≠
            </div>
          </div>
        `;
      }).join('');
      
      document.getElementById('accountsList').innerHTML = html || '<div class="empty-state">≈Ω√°dn√© √∫ƒçty</div>';
    }
    
    function showAddAccountModal() {
      document.getElementById('newAccountName').value = '';
      document.getElementById('newAccountIcon').value = 'üí∞';
      document.getElementById('newAccountBalance').value = '0';
      showModal('addAccountModal');
    }
    
    function addNewAccount() {
      const name = document.getElementById('newAccountName').value.trim();
      const icon = document.getElementById('newAccountIcon').value.trim() || 'üí∞';
      const initialBalance = parseFloat(document.getElementById('newAccountBalance').value) || 0;
      
      if (!name) {
        alert('‚ö†Ô∏è Zadej n√°zev √∫ƒçtu');
        return;
      }
      
      // Generate unique ID
      const id = 'acc_' + Date.now();
      
      data.accounts.push({
        id: id,
        name: name,
        icon: icon,
        initialBalance: initialBalance
      });
      
      saveData();
      updateUI();
      closeModal('addAccountModal');
      renderAccountsList();
      
      alert(`‚úÖ √öƒçet "${name}" byl p≈ôid√°n!`);
    }
    
    let currentEditAccountId = null;
    
    function editAccountModal(accountId) {
      currentEditAccountId = accountId;
      const account = data.accounts.find(a => a.id === accountId);
      
      if (!account) return;
      
      document.getElementById('editAccountName').value = account.name;
      document.getElementById('editAccountIcon').value = account.icon;
      document.getElementById('editAccountBalance').value = account.initialBalance;
      
      showModal('editAccountModal');
    }
    
    function saveEditAccount() {
      if (!currentEditAccountId) return;
      
      const account = data.accounts.find(a => a.id === currentEditAccountId);
      if (!account) return;
      
      account.name = document.getElementById('editAccountName').value.trim();
      account.icon = document.getElementById('editAccountIcon').value.trim();
      account.initialBalance = parseFloat(document.getElementById('editAccountBalance').value) || 0;
      
      saveData();
      updateUI();
      closeModal('editAccountModal');
      renderAccountsList();
      currentEditAccountId = null;
    }
    
    function deleteAccount() {
      if (!currentEditAccountId) return;
      
      const account = data.accounts.find(a => a.id === currentEditAccountId);
      if (!account) return;
      
      const transactionCount = data.transactions.filter(t => t.account === currentEditAccountId).length;
      
      if (transactionCount > 0) {
        if (!confirm(`‚ö†Ô∏è Tento √∫ƒçet m√° ${transactionCount} transakc√≠. Opravdu smazat? Transakce z≈Østanou, ale ztrat√≠ √∫ƒçet.`)) {
          return;
        }
      } else {
        if (!confirm(`Opravdu smazat √∫ƒçet "${account.name}"?`)) {
          return;
        }
      }
      
      data.accounts = data.accounts.filter(a => a.id !== currentEditAccountId);
      
      saveData();
      updateUI();
      closeModal('editAccountModal');
      renderAccountsList();
      currentEditAccountId = null;
    }
    
    function renderGoals() {
      const html = data.goals.length ? data.goals.map(goal => {
        const progress = (goal.current / goal.target) * 100;
        const daysUntil = Math.ceil((new Date(goal.date) - new Date()) / (1000 * 60 * 60 * 24));
        
        return `
          <div class="envelope-card">
            <div class="envelope-header">
              <div class="envelope-name">üéØ ${goal.name}</div>
              <button class="btn-danger btn-small" onclick="deleteGoal(${goal.id})">Smazat</button>
            </div>
            <div class="envelope-amount">${formatCurrency(goal.current)}</div>
            <div class="progress-container">
              <div class="progress-label">
                <span>C√≠l: ${formatCurrency(goal.target)}</span>
                <span>${progress.toFixed(0)}%</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${Math.min(progress, 100)}%"></div>
              </div>
            </div>
            <div style="font-size: 14px; color: #94a3b8; margin-top: 10px;">
              üìÖ ${new Date(goal.date).toLocaleDateString('cs-CZ')} (${daysUntil} dn≈Ø)
            </div>
            <button class="btn-primary btn-small" onclick="addToGoal(${goal.id})" style="margin-top: 15px;">P≈ôidat pen√≠ze</button>
          </div>
        `;
      }).join('') : '<div class="empty-state">Zat√≠m ≈æ√°dn√© c√≠le</div>';
      
      document.getElementById('goalsList').innerHTML = html;
    }
    
    function showAddGoal() {
      showModal('addGoalModal');
    }
    
    function saveGoal() {
      const name = document.getElementById('goalName').value.trim();
      const target = parseFloat(document.getElementById('goalTarget').value);
      const current = parseFloat(document.getElementById('goalCurrent').value) || 0;
      const date = document.getElementById('goalDate').value;
      
      if (!name || !target || !date) {
        alert('Vypl≈àte v≈°echna pole');
        return;
      }
      
      data.goals.push({
        id: Date.now(),
        name,
        target,
        current,
        date
      });
      
      saveData();
      closeModal('addGoalModal');
      renderGoals();
      
      // Reset form
      document.getElementById('goalName').value = '';
      document.getElementById('goalTarget').value = '';
      document.getElementById('goalCurrent').value = '0';
      document.getElementById('goalDate').value = '';
    }
    
    function addToGoal(id) {
      const amount = prompt('Kolik chcete p≈ôidat?');
      if (!amount) return;
      
      const goal = data.goals.find(g => g.id === id);
      if (goal) {
        goal.current += parseFloat(amount);
        saveData();
        renderGoals();
      }
    }
    
    function deleteGoal(id) {
      if (!confirm('Opravdu smazat tento c√≠l?')) return;
      
      data.goals = data.goals.filter(g => g.id !== id);
      saveData();
      renderGoals();
    }
    
    // Charts
    function updateCharts() {
      // Update chart month display
      if (document.getElementById('chartMonth')) {
        document.getElementById('chartMonth').textContent = `${monthNames[chartMonth]} ${chartYear}`;
      }
      
      drawIncomeExpenseChart();
      drawCategoryChart();
      drawAccountChart();
      drawIncomeAccountChart();
    }
    
    function drawPieChart(canvasId, data, colors, clickCallback) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;
      
      const ctx = canvas.getContext('2d');
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;
      const radius = Math.min(centerX, centerY) - 20;
      
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      const total = data.reduce((sum, item) => sum + item.value, 0);
      let currentAngle = -Math.PI / 2;
      
      // Store slice data
      const slices = [];
      
      data.forEach((item, index) => {
        const sliceAngle = (item.value / total) * Math.PI * 2;
        
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
        ctx.closePath();
        ctx.fillStyle = colors[index % colors.length];
        ctx.fill();
        
        slices.push({
          startAngle: currentAngle,
          endAngle: currentAngle + sliceAngle,
          data: item,
          index: index
        });
        
        currentAngle += sliceAngle;
      });
      
      // Click handler
      canvas.onclick = function(e) {
        if (!clickCallback) return;
        
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX - rect.left) * (canvas.width / rect.width);
        const y = (e.clientY - rect.top) * (canvas.height / rect.height);
        
        const dx = x - centerX;
        const dy = y - centerY;
        const distance = Math.sqrt(dx * dx + dy * dy);
        
        if (distance <= radius) {
          let angle = Math.atan2(dy, dx);
          if (angle < -Math.PI / 2) angle += 2 * Math.PI;
          
          for (let slice of slices) {
            if (angle >= slice.startAngle && angle <= slice.endAngle) {
              clickCallback(slice.data, slice.index);
              break;
            }
          }
        }
      };
      
      canvas.style.cursor = 'pointer';
    }
    
    function drawIncomeExpenseChart() {
      // Filter by chartMonth and chartYear
      const monthTx = data.transactions.filter(t => {
        const date = new Date(t.date);
        return date.getMonth() === chartMonth && date.getFullYear() === chartYear;
      });
      
      const income = monthTx.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
      const expense = monthTx.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
      
      const chartData = [
        { label: 'P≈ô√≠jmy', value: income, type: 'incomeExpense' },
        { label: 'V√Ωdaje', value: expense, type: 'incomeExpense' }
      ];
      const chartColors = ['#10b981', '#ef4444'];
      
      drawPieChart('incomeExpenseChart', chartData, chartColors, (data) => {
        showDrilldown('incomeExpense', data.label);
      });
      
      const legendHtml = chartData.map((item, i) => `
        <div class="legend-item" onclick="showDrilldown('incomeExpense', '${item.label}')">
          <div class="legend-color" style="background: ${chartColors[i]};"></div>
          <div class="legend-label">${item.label}</div>
          <div class="legend-value">${formatCurrency(item.value)}</div>
        </div>
      `).join('');
      
      document.getElementById('incomeExpenseeLegend').innerHTML = legendHtml;
    }
    
    function drawCategoryChart() {
      const categoryData = {};
      data.transactions.filter(t => {
        const date = new Date(t.date);
        return t.type === 'expense' && date.getMonth() === chartMonth && date.getFullYear() === chartYear;
      }).forEach(t => {
        if (!categoryData[t.category]) categoryData[t.category] = 0;
        categoryData[t.category] += t.amount;
      });
      
      const chartData = Object.entries(categoryData).map(([label, value]) => ({ label, value }));
      const chartColors = chartData.map(item => getCategoryColor(item.label, 'expense'));
      
      drawPieChart('categoryChart', chartData, chartColors, (data) => {
        showDrilldown('category', data.label);
      });
      
      const legendHtml = chartData.map((item, i) => `
        <div class="legend-item" onclick="showDrilldown('category', '${item.label}')">
          <div class="legend-color" style="background: ${chartColors[i]};"></div>
          <div class="legend-label">${item.label}</div>
          <div class="legend-value">${formatCurrency(item.value)}</div>
        </div>
      `).join('');
      
      document.getElementById('categoryLegend').innerHTML = legendHtml || '<div class="empty-state">Zat√≠m ≈æ√°dn√© v√Ωdaje</div>';
    }
    
    function drawAccountChart() {
      const accountData = {};
      data.accounts.forEach(acc => {
        const expenses = data.transactions.filter(t => {
          const date = new Date(t.date);
          return t.account === acc.id && t.type === 'expense' && 
                 date.getMonth() === chartMonth && date.getFullYear() === chartYear;
        }).reduce((sum, t) => sum + t.amount, 0);
        if (expenses > 0) accountData[acc.id] = expenses;
      });
      
      const chartData = Object.entries(accountData).map(([label, value]) => ({ 
        label: getAccountName(label), 
        value, 
        id: label 
      }));
      const chartColors = ['#ef4444', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6', '#ec4899', '#06b6d4', '#f97316'];
      
      drawPieChart('accountChart', chartData, chartColors, (data) => {
        showDrilldown('account', data.id);
      });
      
      const legendHtml = chartData.map((item, i) => `
        <div class="legend-item" onclick="showDrilldown('account', '${item.id}')">
          <div class="legend-color" style="background: ${chartColors[i % chartColors.length]};"></div>
          <div class="legend-label">${item.label}</div>
          <div class="legend-value">${formatCurrency(item.value)}</div>
        </div>
      `).join('');
      
      document.getElementById('accountLegend').innerHTML = legendHtml || '<div class="empty-state">Zat√≠m ≈æ√°dn√© v√Ωdaje</div>';
    }
    
    function drawIncomeAccountChart() {
      const accountData = {};
      data.accounts.forEach(acc => {
        const income = data.transactions.filter(t => {
          const date = new Date(t.date);
          return t.account === acc.id && t.type === 'income' && 
                 date.getMonth() === chartMonth && date.getFullYear() === chartYear;
        }).reduce((sum, t) => sum + t.amount, 0);
        if (income > 0) accountData[acc.id] = income;
      });
      
      const chartData = Object.entries(accountData).map(([label, value]) => ({ 
        label: getAccountName(label), 
        value, 
        id: label 
      }));
      const chartColors = ['#10b981', '#06b6d4', '#8b5cf6', '#f59e0b', '#ef4444', '#ec4899', '#3b82f6', '#14b8a6'];
      
      drawPieChart('incomeAccountChart', chartData, chartColors, (data) => {
        showDrilldown('incomeAccount', data.id);
      });
      
      const legendHtml = chartData.map((item, i) => `
        <div class="legend-item" onclick="showDrilldown('incomeAccount', '${item.id}')">
          <div class="legend-color" style="background: ${chartColors[i % chartColors.length]};"></div>
          <div class="legend-label">${item.label}</div>
          <div class="legend-value">${formatCurrency(item.value)}</div>
        </div>
      `).join('');
      
      document.getElementById('incomeAccountLegend').innerHTML = legendHtml || '<div class="empty-state">Zat√≠m ≈æ√°dn√© p≈ô√≠jmy</div>';
    }
    
    function showDrilldown(type, value) {
      let transactions = [];
      let title = '';
      
      if (type === 'incomeExpense') {
        transactions = data.transactions.filter(t => t.type === (value === 'P≈ô√≠jmy' ? 'income' : 'expense'));
        title = value;
      } else if (type === 'category') {
        transactions = data.transactions.filter(t => t.category === value);
        title = `Kategorie: ${value}`;
      } else if (type === 'account') {
        transactions = data.transactions.filter(t => t.account === value && t.type === 'expense');
        title = `V√Ωdaje z √∫ƒçtu: ${getAccountName(value)}`;
      } else if (type === 'incomeAccount') {
        transactions = data.transactions.filter(t => t.account === value && t.type === 'income');
        title = `P≈ô√≠jmy na √∫ƒçet: ${getAccountName(value)}`;
      }
      
      document.getElementById('drilldownTitle').textContent = title;
      
      const html = transactions.length ? transactions.map(t => {
        const color = getCategoryColor(t.category, t.type);
        return `
          <div style="display: flex; align-items: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid rgba(148, 163, 184, 0.2); cursor: pointer;" onclick="closeModal('drilldownModal'); editTransaction(${t.id});">
            <div class="transaction-badge" style="background: ${color};">
              ${t.type === 'income' ? '‚Üë' : '‚Üì'}
            </div>
            <div style="flex: 1;">
              <div class="transaction-category">${t.category}</div>
              <div class="transaction-details">
                ${t.description || getAccountName(t.account)} ‚Ä¢ ${new Date(t.date).toLocaleDateString('cs-CZ')}
              </div>
            </div>
            <div class="transaction-amount ${t.type}">
              ${t.type === 'income' ? '+' : '-'}${formatCurrency(t.amount)}
            </div>
          </div>
        `;
      }).join('') : '<div class="empty-state">≈Ω√°dn√© transakce</div>';
      
      document.getElementById('drilldownContent').innerHTML = html;
      showModal('drilldownModal');
    }
    
    // Initialize
    loadData();
    document.getElementById('date').value = new Date().toISOString().split('T')[0];
    updateCategorySelect();
    
    // Check recurring payments daily
    setInterval(processRecurring, 1000 * 60 * 60 * 24);
    
    // Back button handling - prevent app from closing
    let modalOpen = false;
    
    // Track if any modal is open
    const originalShowModal = showModal;
    showModal = function(id) {
      originalShowModal(id);
      modalOpen = true;
      history.pushState({modal: id}, '');
    };
    
    const originalCloseModal = closeModal;
    closeModal = function(id) {
      originalCloseModal(id);
      modalOpen = false;
    };
    
    // Handle back button
    window.addEventListener('popstate', (e) => {
      // Close any open modal
      const modals = document.querySelectorAll('.modal.show');
      if (modals.length > 0) {
        modals.forEach(modal => {
          modal.classList.remove('show');
        });
        modalOpen = false;
      } else if (document.getElementById('sideMenu').classList.contains('open')) {
        // Close menu
        toggleMenu();
      } else {
        // If nothing is open, push state again to prevent app closing
        history.pushState(null, '');
      }
    });
    
    // Initial state to prevent back from closing app
    history.pushState(null, '');
    
    // Register Service Worker for PWA
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .then(reg => console.log('‚úÖ Service Worker registrov√°n:', reg.scope))
          .catch(err => console.log('‚ùå Service Worker chyba:', err));
      });
    }
    
    // Install prompt - VYPNUTO (manu√°ln√≠ instalace p≈ôes menu prohl√≠≈æeƒçe)
    // U≈æivatel m≈Ø≈æe st√°le nainstalovat p≈ôes Menu (‚ãÆ) ‚Üí "P≈ôidat na plochu"
    
    let deferredPrompt;
    
    window.addEventListener('beforeinstallprompt', (e) => {
      console.log('‚úÖ PWA je p≈ôipravena k instalaci');
      console.log('üí° Pro instalaci: Menu (‚ãÆ) ‚Üí "P≈ôidat na plochu"');
      e.preventDefault();
      deferredPrompt = e;
      // V√Ωzva se NEZOBRAZ√ç automaticky
    });
    
    // Track installation
    window.addEventListener('appinstalled', () => {
      console.log('üéâ PWA √∫spƒõ≈°nƒõ nainstalov√°na!');
    });
    
    // Dashboard card click handlers
    function showAccountDetail(account) {
      let transactions = data.transactions.filter(t => t.account === account);
      let title = `${getAccountName(account)} - v≈°echny transakce`;
      
      document.getElementById('drilldownTitle').textContent = title;
      
      const html = transactions.length ? transactions.map(t => {
        const color = getCategoryColor(t.category, t.type);
        return `
          <div style="display: flex; align-items: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid rgba(148, 163, 184, 0.2); cursor: pointer;" onclick="closeModal('drilldownModal'); editTransaction(${t.id});">
            <div class="transaction-badge" style="background: ${color};">
              ${t.type === 'income' ? '‚Üë' : '‚Üì'}
            </div>
            <div style="flex: 1;">
              <div class="transaction-category">${t.category}</div>
              <div class="transaction-details">
                ${t.description || ''} ‚Ä¢ ${new Date(t.date).toLocaleDateString('cs-CZ')}
              </div>
            </div>
            <div class="transaction-amount ${t.type}">
              ${t.type === 'income' ? '+' : '-'}${formatCurrency(t.amount)}
            </div>
          </div>
        `;
      }).join('') : '<div class="empty-state">≈Ω√°dn√© transakce</div>';
      
      document.getElementById('drilldownContent').innerHTML = html;
      showModal('drilldownModal');
    }
    
    function showMonthlyDetail(type) {
      const now = new Date();
      let transactions = data.transactions.filter(t => {
        const date = new Date(t.date);
        return date.getMonth() === now.getMonth() && 
               date.getFullYear() === now.getFullYear() && 
               t.type === type;
      });
      
      let title = type === 'income' ? 'P≈ô√≠jmy tento mƒõs√≠c' : 'V√Ωdaje tento mƒõs√≠c';
      
      document.getElementById('drilldownTitle').textContent = title;
      
      const html = transactions.length ? transactions.map(t => {
        const color = getCategoryColor(t.category, t.type);
        return `
          <div style="display: flex; align-items: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid rgba(148, 163, 184, 0.2); cursor: pointer;" onclick="closeModal('drilldownModal'); editTransaction(${t.id});">
            <div class="transaction-badge" style="background: ${color};">
              ${t.type === 'income' ? '‚Üë' : '‚Üì'}
            </div>
            <div style="flex: 1;">
              <div class="transaction-category">${t.category}</div>
              <div class="transaction-details">
                ${t.description || getAccountName(t.account)} ‚Ä¢ ${new Date(t.date).toLocaleDateString('cs-CZ')}
              </div>
            </div>
            <div class="transaction-amount ${t.type}">
              ${t.type === 'income' ? '+' : '-'}${formatCurrency(t.amount)}
            </div>
          </div>
        `;
      }).join('') : '<div class="empty-state">≈Ω√°dn√© transakce</div>';
      
      document.getElementById('drilldownContent').innerHTML = html;
      showModal('drilldownModal');
    }
    
    // CSV IMPORT FUNCTION
    function importCSV(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          let csv = e.target.result;
          
          // Fix encoding issues
          csv = csv
            .replace(/√Ñ\u008D/g, 'ƒç')
            .replace(/√Ñ\u009B/g, 'ƒõ')
            .replace(/√É\u00AD/g, '√≠')
            .replace(/√É¬°/g, '√°')
            .replace(/√É¬©/g, '√©')
            .replace(/√É\u00BA/g, '√∫')
            .replace(/√Ö¬Ø/g, '≈Ø')
            .replace(/√Ö¬°/g, '≈°')
            .replace(/√Ö¬æ/g, '≈æ')
            .replace(/√É¬Ω/g, '√Ω')
            .replace(/√Ö\u0099/g, '≈ô')
            .replace(/√Ñ\u008F/g, 'ƒè')
            .replace(/√Ö¬•/g, '≈•')
            .replace(/√Ö\u0088/g, '≈à');
          
          const lines = csv.split('\n');
          const imported = [];
          
          // Category mapping (old -> new)
          const categoryMap = {
            'J√≠dlo': 'J√≠dlo',
            'Supermarket': 'J√≠dlo',
            'Restaurace': 'J√≠dlo',
            'Bar': 'Z√°bava',
            'Kino a divadla': 'Z√°bava',
            'p≈ôedplatn√©': 'Ostatn√≠',
            'PHM': 'Doprava',
            'Auto': 'Doprava',
            'Elekt≈ôina': 'Bydlen√≠',
            'N√°jem': 'Bydlen√≠',
            'zahrada': 'Bydlen√≠',
            'Telefon': 'Bydlen√≠',
            'D≈Øm': 'Bydlen√≠',
            'Dƒõti': 'Ostatn√≠',
            'Kapesn√©': 'Ostatn√≠',
            'Hraƒçky': 'Ostatn√≠',
            'investov√°n√≠': 'Ostatn√≠',
            'poji≈°tƒõn√≠': 'Ostatn√≠',
            'Zdrav√≠ a kr√°sa': 'Zdrav√≠',
            'Obleƒçen√≠': 'Obleƒçen√≠',
            'Elektronika': 'Ostatn√≠',
            'P≈ô√≠slu≈°enstv√≠': 'Ostatn√≠',
            'Pr√°ce': 'Mzda',
            'V√Ωplata': 'Mzda',
            'Pr√©mie': 'Mzda',
            'Jin√©': 'Ostatn√≠',
            'bistro': 'Z√°bava'
          };
          
          // Parse CSV (skip header)
          for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;
            
            const parts = line.split(';');
            if (parts.length < 9) continue;
            
            const dateParts = parts[0].split('-'); // dd-mm-yyyy
            const date = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`; // yyyy-mm-dd
            
            const type = parts[1] === '0' ? 'income' : 'expense';
            const amount = parseFloat(parts[3].replace(',', '.'));
            
            // Get category from column 5 or 6
            let oldCategory = parts[5] || parts[6] || 'Ostatn√≠';
            let category = categoryMap[oldCategory] || oldCategory || 'Ostatn√≠';
            
            // If category doesn't exist in our app, use default
            const categoryExists = data.categories[type].some(c => c.name === category);
            if (!categoryExists) {
              category = type === 'income' ? 'Ostatn√≠' : 'Ostatn√≠';
            }
            
            const description = parts[2] + (parts[4] ? ' - ' + parts[4] : '');
            
            imported.push({
              id: Date.now() + i,
              type: type,
              amount: amount,
              category: category,
              account: 'checking', // Default: Bƒõ≈æn√Ω √∫ƒçet
              description: description.trim(),
              date: date
            });
          }
          
          // Add to existing transactions
          data.transactions = [...imported, ...data.transactions];
          saveData();
          updateUI();
          
          closeMenu();
          alert(`‚úÖ Importov√°no ${imported.length} transakc√≠!`);
          
          // Reset file input
          event.target.value = '';
          
        } catch (error) {
          console.error('Import error:', error);
          alert('‚ùå Chyba p≈ôi importu! Zkontroluj form√°t CSV souboru.');
        }
      };
      
      reader.readAsText(file, 'UTF-8');
    }
  </script>
</body>
</html>
